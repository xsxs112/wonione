<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="cafe24.wio.mapper.TextbookMapper">

<resultMap type="TextbookBasicInfo" id="resultTxbBasicInfo">
	<id property="txbCode" column="txb_code"/>
	<result column="txb_code" 		property="txbCode"/>
	<result column="txb_name" 		property="txbName"/>
	<result column="txb_publisher" 	property="txbPublisher"/>
	<result column="txb_author" 	property="txbAuthor"/>
	<result column="txb_writer" 	property="txbWriter"/>
	<result column="txb_reg_date" 	property="txbRegDate"/>
	<collection property="whTextbook" javaType="java.util.ArrayList" ofType="WhTextbook" resultMap="resultWhTextbook"/>
</resultMap>

<resultMap type="WhTextbook" id="resultWhTextbook">
	<result column="wh_txb_code" 			property="whTxbCode"/>
	<result column="txb_code" 				property="txbCode"/>
	<result column="wh_txb_quantity" 		property="whTxbQuantity"/>
	<result column="wh_txb_date" 			property="whTxbDate"/>
	<result column="stock_txb_quantity"		property="stockTxbQuantity"/>
	<result column="wh_txb_writer" 			property="whTxbWriter"/>
	<result column="wh_txb_reg_date" 		property="whTxbRegDate"/>
	<result column="wh_txb_remark" 			property="whTxbRemark"/>
</resultMap>

<resultMap type="SupplyTextbook" id="resultSupplyTextbook">
	<result column="sup_txb_code" 			property="supTxbCode"/>
	<result column="txb_code" 				property="txbCode"/>
	<result column="sup_txb_quantity" 		property="supTxbQuantity"/>
	<result column="txb_receiver_id" 			property="txbReceiverId"/>
	<result column="sup_txb_date"		property="supTxbDate"/>
	<result column="sup_txb_writer" 			property="supTxbWriter"/>
	<result column="sup_txb_reg_date" 		property="supTxbRegDate"/>
</resultMap>

<!-- 교재지급내역조회 -->
<select id="getTextbookSuppList" resultMap="resultSupplyTextbook">
	SELECT 
			sup_txb_code
		,  txb_code
		,  sup_txb_quantity
		,  txb_receiver_id
		,  sup_txb_date
		,  sup_txb_writer
		,  sup_txb_reg_date
	FROM wt_supply_textbook
</select>

<!-- 교재정보조회 -->
<select id="getTextbookInfoList" resultType="TextbookBasicInfo" resultMap="resultTxbBasicInfo">
	SELECT 
			txb_code
		,   txb_name
		,   txb_publisher
		,   txb_author
		,   txb_writer
		,   txb_reg_date
	FROM 
		wt_textbook_basic_information
</select>

<!-- 입고테이블조회 -->
<select id="getWhTextbookList" resultMap="resultWhTextbook">
	SELECT
		 wh_txb_code
		 , txb_code
		 , wh_txb_quantity
		 , wh_txb_date
		 , stock_txb_quantity
		 , wh_txb_writer
		 , wh_txb_reg_date
		 , wh_txb_remark
	FROM wt_warehousing_textbook

</select>

<!-- 보유교재리스트 조회 -->
<select id="getTextbookOwnList" resultMap="resultTxbBasicInfo">
SELECT
		wt.wh_txb_code
	,	wt.txb_code
	,	wt.wh_txb_quantity
	,	wt.wh_txb_date
	,	wt.stock_txb_quantity
	,	wt.wh_txb_writer
	,	wt.wh_txb_reg_date
	,	wt.wh_txb_remark
	,	tbi.txb_code
	,	tbi.txb_name
	,	tbi.txb_publisher
	,	tbi.txb_author
	,	tbi.txb_writer
	,	tbi.txb_reg_date
FROM
	wt_textbook_basic_information AS tbi
	RIGHT JOIN
	wt_warehousing_textbook AS wt
	on
	tbi.txb_code
	=
	wt.txb_code

</select>

<!-- 최초등록인지 체크 -->
<select id="wahoTextbookCheck" resultMap="resultTxbBasicInfo">

SELECT
		wt.txb_code
	,	wt.stock_txb_quantity
	,	tbi.txb_code
	,	tbi.txb_name
FROM
	wt_textbook_basic_information AS tbi
	LEFT JOIN
	wt_warehousing_textbook AS wt
	on
	tbi.txb_code
	=
	wt.txb_code
</select>

<!-- 교재최초입고등록 -->
<insert id="addFirstWhTextbook" parameterType="WhTextbook">
INSERT INTO wt_warehousing_textbook
	(wh_txb_code
	, txb_code
	, wh_txb_quantity
	, wh_txb_date
	, stock_txb_quantity
	, wh_txb_writer
	, wh_txb_reg_date
	, wh_txb_remark)VALUES (
		CONCAT('wh_txb_code',
			(SELECT LPAD(COUNT(*)+1,5,'0')
		 FROM
		 wt_warehousing_textbook AS wt))
	, #{txbCode}
	, ${whTxbQuantity}
	, CURRENT_TIME()
	, ${whTxbQuantity}
	, 'oid002'
	, CURRENT_TIME()	
	, '');	

</insert>

<!-- 교재입고등록 -->
<insert id="addWhTextbook" parameterType="WhTextbook">
INSERT INTO wt_warehousing_textbook
	(wh_txb_code
	, txb_code
	, wh_txb_quantity
	, wh_txb_date
	, stock_txb_quantity
	, wh_txb_writer
	, wh_txb_reg_date
	, wh_txb_remark)VALUES (
		CONCAT('wh_txb_code',
			(SELECT LPAD(COUNT(*)+1,5,'0')
		 FROM
		 wt_warehousing_textbook AS wt))
	, #{txbCode}
	, ${whTxbQuantity}
	, CURRENT_TIME()
	, (SELECT 
			stock_txb_quantity
		FROM wt_warehousing_textbook AS wt
		WHERE
			txb_code = #{txbCode}
		GROUP BY
			wt.wh_txb_date
		ORDER BY wt.wh_txb_date DESC LIMIT 1)+${whTxbQuantity}
	, 'oid002'
	, CURRENT_TIME()	
	, '');	

</insert>

<!-- 교재코드로 교재정보 가져오기 -->
<select id="getOnlyTxbInfo" resultMap="resultTxbBasicInfo">
	SELECT 
			txb_code
		,   txb_name
		,   txb_publisher
		,   txb_author
		,   txb_writer
		,   txb_reg_date
	FROM 
		wt_textbook_basic_information AS tbi
	WHERE
		tbi.txb_code = #{txbInfoCode};

</select>

<!-- 교재정보등록시 마지막으로 등록된 코드 가져오기 -->
<select id="getAddTxbInfoCode" resultType="String">
SELECT 
	tbi.txb_code 
FROM 
	wt_textbook_basic_information AS tbi
ORDER BY 
	tbi.txb_code DESC LIMIT 1;
</select>

<!-- 교재기초정보등록 -->
<insert id="addTextbookInfo" parameterType="TextbookBasicInfo">
INSERT INTO wt_textbook_basic_information
	( txb_code
	, txb_name
	, txb_publisher
	, txb_author
	, txb_writer
	, txb_reg_date)VALUES (
		CONCAT('txb_',
			(SELECT LPAD(COUNT(*)+1,5,'0')
		 FROM
		 wt_textbook_basic_information AS tbi))
	,  #{txbName}
	,  #{txbPublisher}
	,  #{txbAuthor}
	,  'oid002'
	,  CURRENT_TIME())

</insert>

</mapper>
    
